<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI PDF Search — Professional UI</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--primary:#0f62fe;--accent:#0b7880;--success:#16a34a;--bg:#f4f7fb;--card:#ffffff;--muted:#6b7280;--glass:rgba(255,255,255,0.6);--shadow:0 8px 30px rgba(16,24,40,.08)}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0;background:linear-gradient(180deg,#f6fbff 0%,var(--bg) 100%);color:#0f172a;display:flex;flex-direction:column;align-items:center}
    .container{width:94%;max-width:1180px;padding:28px 0}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:22px}
    h1{margin:0;font-size:20px;letter-spacing:0.2px}
    .subtitle{color:var(--muted);font-size:13px}

    /* Panels */
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--card);border-radius:12px;padding:16px;box-shadow:var(--shadow);}
    .panel h2{margin:0 0 8px;font-size:16px;color:var(--primary)}

    /* Search controls */
    .controls{display:flex;gap:10px;align-items:center}
    .controls .left{flex:1;display:flex;gap:10px}
    input[type=text]{flex:1;padding:12px 14px;border-radius:10px;border:1px solid #e6eef6;font-size:15px;background:#fbfdff}
    select{padding:10px;border-radius:8px;border:1px solid #e6eef6;background:#fff}
    .btn{padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{background:transparent;border:1px solid #e6eef6;color:var(--primary)}

    /* Toggle result type */
    .switch{display:inline-flex;background:#eef6fb;border-radius:999px;padding:4px;border:1px solid #e5f0fb}
    .switch button{border:none;background:transparent;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:700;color:var(--muted)}
    .switch button.active{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff}

    /* Results list */
    #results{margin-top:16px;display:grid;gap:12px}
    .result-row{display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:10px;border:1px solid #eef4fb;background:linear-gradient(180deg,rgba(255,255,255,0.8),#fff)}
    .result-meta{flex:1}
    .result-title{font-weight:800;color:#062162;margin-bottom:6px}
    .result-sub{color:var(--muted);font-size:13px;margin-bottom:8px}
    .score-pill{background:#f1f8ff;padding:6px 8px;border-radius:999px;border:1px solid #e1f0ff;font-weight:700}

    .progress{height:10px;background:#f1f5f9;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;transition:width .6s ease}
    .bar.score{background:linear-gradient(90deg,var(--primary),var(--accent))}
    .bar.sent{background:linear-gradient(90deg,var(--success),#4ade80)}

    .doc-details{font-size:13px;color:var(--muted);margin-top:8px}
    .expand{background:transparent;border:none;color:var(--primary);font-weight:700;cursor:pointer}

    /* Sidebar */
    .sidebar .small{font-size:13px;color:var(--muted);margin-bottom:8px}
    .list-compact{display:flex;flex-direction:column;gap:8px}
    .compact-item{background:#f8fbff;border-radius:8px;padding:10px;border:1px solid #eef6ff;font-size:13px}

    /* Footer */
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}

    /* Modal / loader */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(6,10,20,0.45);z-index:999}
    .modal-card{width:920px;max-width:94vw;background:#0b1222;color:#fff;border-radius:12px;padding:18px}
    .loader{display:inline-block;width:14px;height:14px;border:3px solid rgba(255,255,255,.12);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">AI</div>
        <div>
          <h1>AI PDF Search Engine</h1>
          <div class="subtitle">Fast page-level & document-level retrieval with sentiment & normalized scores</div>
        </div>
      </div>
      <div class="subtitle">Model: <strong id="current-model">TF-IDF</strong></div>
    </header>

    <div class="grid">
      <!-- Main column -->
      <div>
        <div class="panel">
          <h2>Search</h2>
          <div class="controls">
            <div class="left">
              <input id="query" type="text" placeholder="Enter search query — e.g. climate change policy" />
              <select id="search-mode" aria-label="search model">
                <option value="tfidf">TF-IDF</option>
                <option value="lsi">LSI</option>
                <option value="doc2vec">Doc2Vec</option>
              </select>

              <div class="switch" role="tablist" aria-label="Result type">
                <button id="btn-page" class="active" onclick="setResultType('page')">Page-wise</button>
                <button id="btn-doc" onclick="setResultType('document')">Document-wise</button>
              </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:8px;">
              <button id="btn-search" class="btn primary">Search</button>
              <button id="btn-build" class="btn ghost">Build Index</button>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
            <div class="muted">Top K:</div>
            <select id="top-k"><option>5</option><option>10</option><option>20</option></select>
            <div id="status" class="muted">Ready</div>
          </div>

          <div id="results" aria-live="polite"></div>
        </div>

        <!-- compact help / tips -->
        <div class="panel" style="margin-top:12px">
          <h2>Quick Tips</h2>
          <ul style="margin:0;padding-left:18px;color:var(--muted)">
            <li>Use <strong>Document-wise</strong> to see normalized scores (0-1) aggregated across pages.</li>
            <li>Click a document name to open the PDF at the result page.</li>
            <li>Build indexes once after adding documents to the <code>/docs</code> folder.</li>
          </ul>
        </div>
      </div>

      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="panel">
          <h2>Controls</h2>
          <div class="small">Rebuild / Metrics</div>
          <div class="list-compact">
            <div class="compact-item">
              <div style="display:flex;justify-content:space-between"><div>Build Mode</div><select id="build-mode-small"><option>tfidf</option><option>lsi</option><option>doc2vec</option></select></div>
              <div style="margin-top:8px"><button class="btn ghost" id="btn-build-small">Build</button></div>
            </div>

            <div class="compact-item">
              <div style="display:flex;justify-content:space-between"><div>Metrics Mode</div><select id="metrics-mode-small"><option>tfidf</option><option>lsi</option><option>doc2vec</option></select></div>
              <div style="margin-top:8px;display:flex;gap:8px"><button class="btn ghost" id="btn-metrics-small">Metrics</button><button class="btn ghost" id="btn-metrics-all-small">Compare</button></div>
            </div>

            <div class="compact-item muted">Docs directory: <code>/docs</code></div>
          </div>
        </div>

        <div style="height:18px"></div>
        <div class="panel">
          <h2>Recent Actions</h2>
          <div id="log" class="muted">No recent actions</div>
        </div>
      </aside>
    </div>

    <footer>© 2025 — AI PDF Search • Built with Flask</footer>
  </div>

  <!-- Modal placeholder -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card" role="document">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong>Metrics</strong>
        <button onclick="closeModal()" class="btn ghost">Close</button>
      </div>
      <div id="modal-body">Loading… <span class="loader"></span></div>
    </div>
  </div>

  <script>
    // ---------- State ----------
    let resultType = 'page';
    const currentModelEl = document.getElementById('current-model');
    const serverModel = '{{ current_mode if current_mode is defined else "tfidf" }}';
    document.getElementById('search-mode').value = serverModel; document.getElementById('build-mode-small').value = serverModel; document.getElementById('metrics-mode-small').value = serverModel; currentModelEl.textContent = serverModel.toUpperCase();

    // ---------- Helpers ----------
    function setResultType(t){ resultType = t; document.getElementById('btn-page').classList.toggle('active', t==='page'); document.getElementById('btn-doc').classList.toggle('active', t==='document'); }

    function log(msg){ const el = document.getElementById('log'); el.textContent = msg; }

    // ---------- Search ----------
    document.getElementById('btn-search').addEventListener('click', doSearch);
    document.getElementById('btn-search').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });

    async function doSearch(){
      const q = document.getElementById('query').value.trim();
      const mode = document.getElementById('search-mode').value;
      const k = document.getElementById('top-k').value || 5;
      if(!q){ alert('Please enter a query'); return; }
      const status = document.getElementById('status'); status.textContent = `Searching (${mode.toUpperCase()})...`;
      log(`Searching: "${q}" [${mode}] (${resultType})`);

      try{
        const res = await fetch(`/search?query=${encodeURIComponent(q)}&mode=${mode}&k=${k}&result_type=${resultType}`);
        const data = await res.json();
        if(!res.ok){ throw new Error(data?.error || 'Search failed'); }
        renderResults(data);
        status.textContent = `Showing ${data.results.length} results (${data.result_type || 'page'})`;
      }catch(err){ console.error(err); status.textContent = 'Search error'; log('Search failed: '+err.message); document.getElementById('results').innerHTML = `<div class="panel" style="border-left:4px solid #f43f5e">Error: ${err.message}</div>`; }
    }

    // ---------- Render ----------
    function renderResults(data){ const root = document.getElementById('results'); root.innerHTML = '';
      if(!data.results || !data.results.length){ root.innerHTML = '<div class="panel">No results</div>'; return; }

      if((data.result_type || 'page') === 'page'){
        data.results.forEach(r=> root.appendChild(renderPageRow(r)));
      }else{
        data.results.forEach(d=> root.appendChild(renderDocRow(d)));
      }
    }

    function renderPageRow(r){
      const row = document.createElement('div'); row.className='result-row';
      const meta = document.createElement('div'); meta.className='result-meta';
      const title = document.createElement('div'); title.className='result-title'; title.innerHTML = `<a href='${r.url}' target='_blank' rel='noopener'>${r.name}</a> <span style="font-weight:600;color:var(--muted);font-size:13px">— Page ${r.page}</span>`;
      const sub = document.createElement('div'); sub.className='result-sub'; sub.innerHTML = `<span class='score-pill'>Score ${r.score.toFixed(4)}</span> &nbsp; <span class='score-pill'>Sent ${r.sentiment.toFixed(3)}</span>`;
      const progress = document.createElement('div'); progress.className='progress';
      const bar = document.createElement('div'); bar.className='bar score'; bar.style.width = Math.min(100, Math.max(4, (r.score*100))).toFixed(1) + '%'; progress.appendChild(bar);

      meta.appendChild(title); meta.appendChild(sub); meta.appendChild(progress);
      row.appendChild(meta);
      return row;
    }

    function renderDocRow(d){
      const row = document.createElement('div'); row.className='result-row';
      const meta = document.createElement('div'); meta.className='result-meta';
      const title = document.createElement('div'); title.className='result-title';
      title.innerHTML = `<a href='${d.path + '#page=' + (d.pages?.[0]?.page || 1)}' target='_blank' rel='noopener'>${d.name}</a> <span style="font-weight:600;color:var(--muted);font-size:13px">• ${d.pages?.length || 0} pages</span>`;

      const sub = document.createElement('div'); sub.className='result-sub';
      sub.innerHTML = `<strong>Normalized:</strong> ${ (d.normalized_score ?? d.normalized ?? d.raw_score ?? 0).toFixed(4) } &nbsp;|&nbsp; <strong>Raw:</strong> ${(d.raw_score ?? 0).toFixed(4)} &nbsp;|&nbsp; <strong>Sent:</strong> ${(d.raw_sentiment ?? 0).toFixed(3)}`;

      const progress = document.createElement('div'); progress.className='progress';
      const bar = document.createElement('div'); bar.className='bar score'; bar.style.width = ((d.normalized_score ?? 0) * 100).toFixed(1) + '%'; progress.appendChild(bar);

      const expandBtn = document.createElement('button'); expandBtn.className='expand'; expandBtn.textContent='Show pages';
      const details = document.createElement('div'); details.className='doc-details'; details.style.display='none';
      if(Array.isArray(d.pages)){
        details.innerHTML = d.pages.map(p=>`<div style="padding:6px 0;border-top:1px dashed #eef6ff"><strong>Page ${p.page}</strong> — Score ${p.score.toFixed(4)} • Sent ${p.sentiment.toFixed(3)} &nbsp; <a href='${p.url}' target='_blank'>Open</a></div>`).join('');
      }

      expandBtn.addEventListener('click', ()=>{
        const open = details.style.display === 'block'; details.style.display = open ? 'none' : 'block'; expandBtn.textContent = open ? 'Show pages' : 'Hide pages';
      });

      meta.appendChild(title); meta.appendChild(sub); meta.appendChild(progress); meta.appendChild(expandBtn); meta.appendChild(details);
      row.appendChild(meta);
      return row;
    }

    // ---------- Build / Metrics (sidebar) ----------
    document.getElementById('btn-build').addEventListener('click', ()=>buildIndex(document.getElementById('search-mode').value));
    document.getElementById('btn-build-small').addEventListener('click', ()=>buildIndex(document.getElementById('build-mode-small').value));

    async function buildIndex(mode){ log('Building '+mode); const btn = document.querySelectorAll('#btn-build, #btn-build-small'); btn.forEach(b=>b.disabled=true); try{ const res = await fetch(`/build_index?mode=${mode}`, {method:'POST'}); const data = await res.json(); if(!res.ok) throw new Error(data?.error || 'Build failed'); log(data.message); alert(data.message); }catch(e){ log('Build failed'); alert('Build failed: '+e.message); } finally{ btn.forEach(b=>b.disabled=false); } }

    // Metrics (compact)
    document.getElementById('btn-metrics-small').addEventListener('click', async ()=>{ const m = document.getElementById('metrics-mode-small').value; openModal(); try{ const res = await fetch(`/metrics?mode=${m}`); const data = await res.json(); document.getElementById('modal-body').innerHTML = `<pre style="white-space:pre-wrap;color:#d1d5db">${JSON.stringify(data,null,2)}</pre>`; }catch(e){ document.getElementById('modal-body').textContent = 'Could not load metrics'; } });
    document.getElementById('btn-metrics-all-small').addEventListener('click', async ()=>{ openModal(); try{ const res = await fetch('/metrics_all'); const data = await res.json(); document.getElementById('modal-body').innerHTML = `<pre style="white-space:pre-wrap;color:#d1d5db">${JSON.stringify(data,null,2)}</pre>`; }catch(e){ document.getElementById('modal-body').textContent = 'Could not load metrics'; } });

    function openModal(){ document.getElementById('modal').style.display='flex'; document.getElementById('modal-body').innerHTML = 'Loading… <span class="loader"></span>'; }
    function closeModal(){ document.getElementById('modal').style.display='none'; }
  </script>
</body>
</html>