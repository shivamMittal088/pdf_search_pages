<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI PDF Search Engine</title>
  <style>
    :root{
      --primary:#007bff;--accent:#17a2b8;--success:#28a745;
      --bg:#eef2f5;--text:#1d1d1f;--card:#fff;--shadow:rgba(0,0,0,.15)
    }
    *{box-sizing:border-box}
    body{font-family:"Poppins","Segoe UI",sans-serif;background:var(--bg);color:var(--text);margin:0;display:flex;flex-direction:column;align-items:center;min-height:100vh}
    header{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;width:100%;text-align:center;padding:26px 12px;box-shadow:0 3px 6px var(--shadow)}
    header h1{margin:0;font-size:28px;letter-spacing:.5px}
    main{width:92%;max-width:1100px;margin:28px 0}
    .panel{background:var(--card);padding:22px;border-radius:12px;box-shadow:0 4px 10px var(--shadow);margin-bottom:22px;transition:transform .2s}
    .panel:hover{transform:translateY(-2px)}
    .panel h2{margin:0 0 14px;color:var(--primary);font-size:20px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:10px 12px;border-radius:8px;border:1px solid #cfd8e3;font-size:15px}
    input{flex:1;min-width:260px}
    select{background:#e8f8fc;border-color:#9bd3e0}
    button{background:var(--primary);color:#fff;border:none;cursor:pointer;font-weight:600;transition:.25s}
    button:hover{filter:brightness(.92)}
    .btn-build{background:var(--accent)}
    #status{margin-top:10px;text-align:center;color:var(--accent);font-weight:600}
    #results{margin-top:22px;display:grid;grid-template-columns:1fr;gap:14px}
    .card{background:var(--card);padding:18px 20px;border-radius:10px;box-shadow:0 2px 8px var(--shadow);transition:all .2s}
    .card:hover{transform:translateY(-2px);box-shadow:0 6px 14px var(--shadow)}
    .title{font-weight:700;color:var(--primary);font-size:18px}
    .title a{color:var(--primary);text-decoration:none}
    .title a:hover{text-decoration:underline}
    .meta{margin-top:6px;color:#555;font-size:14px}
    .bar{height:8px;background:#e9ecef;border-radius:8px;margin-top:10px;overflow:hidden}
    .fill{height:100%;background:var(--success);width:0;transition:width .6s ease}
    footer{margin-top:auto;padding:16px;color:#6b7280}
    .loader{display:inline-block;width:16px;height:16px;border:3px solid rgba(0,0,0,.1);border-radius:50%;border-top-color:var(--accent);animation:spin 1s linear infinite;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Modal */
    .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);align-items:center;justify-content:center;z-index:1000}
    .modal{background:#0f172a;color:#fff;width:520px;max-width:92vw;border-radius:14px;padding:16px 16px 12px;border:1px solid #334155;box-shadow:0 20px 60px rgba(0,0,0,.5)}
    .modal-header{display:flex;align-items:center;justify-content:space-between}
    .modal-header h3{margin:0;font-size:20px}
    .modal-close{background:transparent;border:none;color:#94a3b8;font-size:20px;cursor:pointer}
    .tabs{margin-top:12px;background:#111827;border-radius:10px;padding:6px;display:flex;gap:8px}
    .tab{flex:1;padding:8px 0;border:none;border-radius:8px;background:#1f2937;color:#cbd5e1;cursor:pointer}
    .tab.active{background:#0b1222;color:#fff;border:1px solid #334155}
    .metrics-grid{margin-top:14px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .metric-card{background:#0b1222;border:1px solid #334155;border-radius:12px;padding:18px;text-align:center}
    .metric-val{font-size:28px;font-weight:800;margin-bottom:6px}
    .metric-label{color:#93a3b8}
    .meta-row{display:flex;justify-content:space-between;color:#93a3b8;margin-top:8px;font-size:12px}
    .muted{color:#6b7280}
    .danger{color:#b91c1c}
  </style>
</head>
<body>
  <header><h1>ü§ñ AI-Powered PDF Search Engine</h1></header>

  <main>
    <!-- Search -->
    <div class="panel">
      <h2>üîé Search Documents</h2>
      <div class="controls">
        <input id="query" type="text" placeholder="Enter your search query‚Ä¶"/>
        <select id="search-mode">
          <option value="tfidf">TF-IDF</option>
          <option value="lsi">LSI</option>
          <option value="doc2vec">Doc2Vec</option>
        </select>
        <button id="btn-search">Search</button>
      </div>
      <div id="status">‚úÖ Current Search Model: <span id="current-model">TF-IDF</span></div>
    </div>

    <!-- Build / Metrics -->
    <div class="panel">
      <h2>‚öôÔ∏è Rebuild Index & Metrics</h2>
      <div class="controls">
        <label for="build-mode">Rebuild:</label>
        <select id="build-mode">
          <option value="tfidf">TF-IDF</option>
          <option value="lsi">LSI</option>
          <option value="doc2vec">Doc2Vec</option>
        </select>
        <button class="btn-build" id="btn-build">Build Selected Index</button>

        <label style="margin-left:8px" for="metrics-mode">Metrics for:</label>
        <select id="metrics-mode">
          <option value="tfidf">TF-IDF</option>
          <option value="lsi">LSI</option>
          <option value="doc2vec">Doc2Vec</option>
        </select>
        <button style="background:#111;color:#fff;border:1px solid #333" id="btn-metrics">üìä Performance</button>
      </div>
      <div class="muted">Tip: build each index once before searching in that mode.</div>
    </div>

    <!-- Results -->
    <div id="results"></div>
  </main>

  <footer>¬© 2025 AI PDF Search Engine ‚Äî Flask + ML</footer>

  <!-- Metrics Modal -->
  <div id="metrics-modal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3>Performance Metrics</h3>
        <button class="modal-close" onclick="closeMetrics()">‚úï</button>
      </div>

      <div class="tabs">
        <button id="tab-pages" class="tab active" onclick="switchTab('pages')">Pages</button>
        <button id="tab-docs"  class="tab" onclick="switchTab('docs')">Docs</button>
      </div>

      <div class="metrics-grid" id="metrics-cards"></div>

      <div class="meta-row">
        <div>Mode: <span id="m-mode">-</span></div>
        <div>K: <span id="m-k">-</span></div>
      </div>
    </div>
  </div>

  <script>
    // -------- Initial state from server (TF-IDF default on backend) ----------
    const serverMode = "{{ current_mode if current_mode is defined else 'tfidf' }}";
    const elCurrent = document.getElementById("current-model");
    const elSearchMode = document.getElementById("search-mode");
    const elMetricsMode = document.getElementById("metrics-mode");
    const elBuildMode = document.getElementById("build-mode");
    const elStatus = document.getElementById("status");
    const elResults = document.getElementById("results");

    // Set dropdowns/label to server mode
    elSearchMode.value = serverMode;
    elMetricsMode.value = serverMode;
    elBuildMode.value = serverMode;
    elCurrent.textContent = serverMode.toUpperCase();

    // Keep label in sync when user switches the search mode
    elSearchMode.addEventListener("change", e => {
      elCurrent.textContent = e.target.value.toUpperCase();
    });

    // Enter-to-search
    document.getElementById("query").addEventListener("keydown", (e) => {
      if (e.key === "Enter") search();
    });

    // Button handlers
    document.getElementById("btn-search").addEventListener("click", search);
    document.getElementById("btn-build").addEventListener("click", buildIndex);
    document.getElementById("btn-metrics").addEventListener("click", openMetrics);

    // -------- Search ----------
    async function search() {
      const q = document.getElementById("query").value.trim();
      const mode = elSearchMode.value;
      const btn = document.getElementById("btn-search");

      if (!q) {
        elResults.innerHTML = "<p>Please enter a query.</p>";
        return;
      }

      elStatus.innerHTML = `üîé Searching with ${mode.toUpperCase()} <span class="loader"></span>`;
      btn.disabled = true;

      try {
        const res = await fetch(`/search?query=${encodeURIComponent(q)}&mode=${mode}`);
        const data = await res.json();

        if (!res.ok || data.error) {
          if (data.need_build) {
            elStatus.innerHTML = `‚ö†Ô∏è ${data.error} ‚Äî go to <b>Rebuild</b> and build <b>${mode.toUpperCase()}</b>.`;
            elResults.innerHTML = `<p class="muted">Index not built for ${mode.toUpperCase()}. Click <em>Build Selected Index</em> first.</p>`;
            return;
          }
          throw new Error(data?.error || `HTTP ${res.status}`);
        }

        if (!data.results || data.results.length === 0) {
          elResults.innerHTML = "<p>No results found.</p>";
          elStatus.textContent = "‚ö†Ô∏è No results found.";
          return;
        }

        elStatus.textContent = `‚úÖ Found ${data.results.length} results using ${data.mode.toUpperCase()}.`;

        elResults.innerHTML = "";
        data.results.forEach((r, i) => {
          const el = document.createElement("div");
          el.className = "card";
          el.innerHTML = `
            <div class="title">${i + 1}. <a href="${r.url}" target="_blank" rel="noopener">${r.name}</a>
              <span style="color:#666;font-weight:500"> (Page ${r.page})</span>
            </div>
            <div class="meta"><b>Score:</b> ${r.score.toFixed(4)} &nbsp;|&nbsp; <b>Sentiment:</b> ${r.sentiment.toFixed(3)}</div>
            <div class="bar"><div class="fill" style="width:${(r.score * 100).toFixed(1)}%"></div></div>
          `;
          elResults.appendChild(el);
        });
      } catch (err) {
        console.error(err);
        elResults.innerHTML = `<p class="danger">‚ùå Search failed: ${err.message}</p>`;
        elStatus.innerHTML = `<span class="danger">‚ùå Search failed.</span>`;
      } finally {
        btn.disabled = false;
      }
    }

    // -------- Build index ----------
    async function buildIndex() {
      const mode = elBuildMode.value;
      const btn = document.getElementById("btn-build");

      elStatus.innerHTML = `‚öôÔ∏è Building ${mode.toUpperCase()} index‚Ä¶ <span class="loader"></span>`;
      btn.disabled = true;

      try {
        const res = await fetch(`/build_index?mode=${mode}`, { method: "POST" });
        const data = await res.json();

        if (!res.ok || data.error) {
          throw new Error(data?.error || `HTTP ${res.status}`);
        }
        elStatus.textContent = `‚úÖ ${data.message}`;
      } catch (e) {
        console.error(e);
        elStatus.innerHTML = `<span class="danger">‚ùå Failed to build ${mode.toUpperCase()} index: ${e.message}</span>`;
      } finally {
        btn.disabled = false;
      }
    }

    // --------- Metrics modal ----------
    let metricsCache = null;
    let activeTab = 'pages';

    function openMetrics() {
      fetchMetrics().then(() => {
        document.getElementById("metrics-modal").style.display = "flex";
        renderMetrics();
      });
    }
    function closeMetrics(){ document.getElementById("metrics-modal").style.display = "none"; }
    function switchTab(tab){
      activeTab = tab;
      document.getElementById("tab-pages").classList.toggle("active", tab==='pages');
      document.getElementById("tab-docs").classList.toggle("active", tab==='docs');
      renderMetrics();
    }

    async function fetchMetrics() {
      const mode = elMetricsMode.value;
      try {
        const res = await fetch(`/metrics?mode=${mode}`);
        metricsCache = await res.json();
      } catch {
        metricsCache = { error: "Bad response" };
      }
    }

    function renderMetrics() {
      const cardsRoot = document.getElementById("metrics-cards");
      if (!metricsCache || metricsCache.error){ 
        cardsRoot.innerHTML = "<div style='grid-column:1/-1;color:#cbd5e1'>No eval_set.json found or index missing for selected mode.</div>";
        document.getElementById("m-mode").textContent = "-";
        document.getElementById("m-k").textContent = "-";
        return;
      }
      if (metricsCache.need_build){
        cardsRoot.innerHTML = `<div style='grid-column:1/-1;color:#cbd5e1'>${metricsCache.error}</div>`;
        document.getElementById("m-mode").textContent = metricsCache.mode?.toUpperCase?.() || "-";
        document.getElementById("m-k").textContent = "-";
        return;
      }

      const data = metricsCache[activeTab];
      const cards = `
        <div class="metric-card">
          <div class="metric-val">${Number(data.recall ?? 0).toFixed(2)}</div>
          <div class="metric-label">Recall</div>
        </div>
        <div class="metric-card">
          <div class="metric-val">${Number(data.precision ?? 0).toFixed(2)}</div>
          <div class="metric-label">Precision</div>
        </div>
        <div class="metric-card">
          <div class="metric-val">${Number(data.f1 ?? 0).toFixed(2)}</div>
          <div class="metric-label">F1 Score</div>
        </div>`;
      cardsRoot.innerHTML = cards;
      document.getElementById("m-mode").textContent = (metricsCache.mode || "").toUpperCase();
      document.getElementById("m-k").textContent = metricsCache.k;
    }
  </script>
</body>
</html>
